name: CI

permissions:
  contents: read
  packages: write
  checks: write

on:
  push:
    branches: [ master, dev ]
  pull_request:
    branches: [ '*']

jobs:
  build-base-image:
    name: Build Base Image
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.meta.outputs.image }}
    steps:
      - uses: actions/checkout@v4
      - name: Compute image name
        id: meta
        run: |
          OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}
          IMAGE=ghcr.io/${OWNER_LC}/project-name/base:${{ github.run_id }}
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build & push
        run: |
          docker build -t "${{ steps.meta.outputs.image }}" .gitlab/ci/base_image
          docker push "${{ steps.meta.outputs.image }}"

  test-running-main-executable:
    name: Test Running Main Executable
    runs-on: ubuntu-latest
    needs: build-base-image
    container:
      image: ${{ needs.build-base-image.outputs.image }}
    if: github.event_name == 'pull_request'
    env:
      NUM_PROCS: 1
    steps:
      - uses: actions/checkout@v4
      - name: Configure build
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          apt update
          apt install -y curl
          cmake --build build --target pipeline-tools -- -j${NUM_PROCS}
      - name: Run server and test
        run: |
          ./build/pipeline-tools &
          SERVER_PID=$!
          sleep 2
          RESPONSE=$(curl -s http://localhost:8081/)
          if [ "$RESPONSE" != "true" ]; then
            echo "Unexpected response: $RESPONSE"
            kill $SERVER_PID || true
            exit 1
          fi
          kill $SERVER_PID || true

  build-docs:
    name: Build Docs
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/heads/master') || startsWith(github.ref, 'refs/heads/dev')
    steps:
      - uses: actions/checkout@v4
      - name: Build docs image
        run: |
          docker build -f docs/Dockerfile -t pipeline-tools/docs:latest .
          docker tag pipeline-tools/docs:latest pipeline-tools/docs:${{ github.ref_name }}

  filter-core-changes:
    name: Filter Core Changes
    runs-on: ubuntu-latest
    outputs:
      core: ${{ steps.filter.outputs.core }}
    steps:
      - uses: actions/checkout@v4
      - name: Check changed paths
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            core:
              - 'core/**'
              - 'CMakeLists.txt'
              - '.gitlab-ci.yml'

  build-core:
    name: Build CORE
    runs-on: ubuntu-latest
    needs: [ build-base-image, filter-core-changes ]
    container:
      image: ${{ needs.build-base-image.outputs.image }}
    if: github.event_name == 'pull_request' && needs.filter-core-changes.outputs.core == 'true'
    env:
      NUM_PROCS: 1
    steps:
      - uses: actions/checkout@v4
      - name: Core before script
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DPIPELINE_TOOLS_ENABLE_TESTS=ON -DGITLAB_USER=gitlab-ci-token -DGITLAB_PAT=${{ secrets.GITHUB_TOKEN }}
      - name: Build core target
        run: |
          cmake --build build --target pipeline-tools-core -- -j${NUM_PROCS}

  test-core:
    name: Test CORE
    runs-on: ubuntu-latest
    needs: [ build-base-image, filter-core-changes ]
    container:
      image: ${{ needs.build-base-image.outputs.image }}
    if: github.event_name == 'pull_request' && needs.filter-core-changes.outputs.core == 'true'
    env:
      NUM_PROCS: 1
    steps:
      - uses: actions/checkout@v4
      - name: Core before script
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DPIPELINE_TOOLS_ENABLE_TESTS=ON -DGITLAB_USER=gitlab-ci-token -DGITLAB_PAT=${{ secrets.GITHUB_TOKEN }}
      - name: Build and run gtests
        run: |
          mkdir -p ./out
          cmake --build build --target pipeline-tools-core-gtest -- -j${NUM_PROCS}
          ./build/core/test/pipeline-tools-core-gtest --gtest_output=xml:./gtest.xml || true
      - name: Install python
        run: |
          apt-get update
          apt-get install -y python3
      - name: Parse junit output
        run: |
          python3 .gitlab/ci/scripts/parse_junit_output.py ./gtest.xml || true
      - name: Upload test report to GitHub
        uses: actions/upload-test-report@v1
        with:
          report: junit
          path: ./gtest.xml

  benchmark-core:
    name: Benchmark CORE
    runs-on: ubuntu-latest
    needs: [ build-base-image, filter-core-changes ]
    container:
      image: ${{ needs.build-base-image.outputs.image }}
    if: github.event_name == 'pull_request' && needs.filter-core-changes.outputs.core == 'true'
    env:
      NUM_PROCS: 1
    steps:
      - uses: actions/checkout@v4
      - name: Core before script
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DPIPELINE_TOOLS_ENABLE_TESTS=ON -DGITLAB_USER=gitlab-ci-token -DGITLAB_PAT=${{ secrets.GITHUB_TOKEN }}
      - name: Run benchmarks
        run: |
          cmake --build build --target pipeline-tools-core-benchmark -- -j${NUM_PROCS}
          ./build/core/test/pipeline-tools-core-benchmark --benchmark_format=json | tee ./benchmark.json
      - name: Install python
        run: |
          apt-get update
          apt-get install -y python3
      - name: Generate performance report
        run: |
          python3 .gitlab/ci/scripts/gbenchmark_to_performance_report.py benchmark.json > performance.json || true
      - name: Upload benchmark artifacts
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-artifacts
          path: |
            benchmark.json
            performance.json
